name: Example CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  commit-stage:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Mock Docker Build Step
        id: docker-build
        run: |
          # This is a mock build step for demonstration purposes
          echo "Simulating Docker build for example purposes"
          
          # Mock outputs that would come from a real Docker build
          echo "image-name=ghcr.io/optivem/example-app:latest" >> $GITHUB_OUTPUT
          echo "image-created=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      - name: Summarize Commit Stage
        if: always()  # Run even if previous steps fail
        uses: optivem/summarize-commit-stage-action@v1
        with:
          stage-result: ${{ job.status }}
          component-name: 'Example Application'
          artifact-url: ${{ steps.docker-build.outputs.image-name }}
          artifact-created-timestamp: ${{ steps.docker-build.outputs.image-created }}
          artifact-type: 'Docker Image'

  multi-component-example:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        component: [frontend, backend, worker]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build component
        id: build
        run: |
          # Simulate building different components
          echo "Building ${{ matrix.component }}"
          
          # Mock outputs that would come from actual build steps
          echo "artifact-url=ghcr.io/example/my-app-${{ matrix.component }}:latest" >> $GITHUB_OUTPUT
          echo "artifact-created-timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      - name: Summarize Component Stage
        if: always()
        uses: optivem/summarize-commit-stage-action@v1
        with:
          stage-result: ${{ job.status }}
          stage-name: 'Component Build'
          component-name: ${{ matrix.component }}
          artifact-url: ${{ steps.build.outputs.artifact-url }}
          artifact-created-timestamp: ${{ steps.build.outputs.artifact-created-timestamp }}
          artifact-type: 'Docker Image'