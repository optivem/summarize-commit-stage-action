name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+' # Only run on semantic version tags like v1.0.0, v1.1.0, etc.

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: extract-version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.extract-version.outputs.tag }}
          name: Release ${{ steps.extract-version.outputs.tag }}
          body: |
            ## Changes in ${{ steps.extract-version.outputs.tag }}
            
            This release includes improvements and updates to the Summarize Commit Stage Action.
            
            ### Usage
            
            ```yaml
            - name: Summarize Commit Stage
              uses: optivem/summarize-commit-stage-action@${{ steps.extract-version.outputs.tag }}
              with:
                stage-result: ${{ job.status }}
                component-name: 'My Component'
                artifact-url: ${{ steps.build.outputs.artifact-url }}
                artifact-created-timestamp: ${{ steps.build.outputs.artifact-created }}
                artifact-type: 'Docker Image'
            ```
            
            For detailed usage instructions, see the [README](https://github.com/optivem/summarize-commit-stage-action#readme).
          draft: false
          prerelease: false

      - name: Update major version tag
        run: |
          TAG=${{ steps.extract-version.outputs.tag }}
          MAJOR_VERSION=$(echo $TAG | cut -d. -f1)
          git config user.name github-actions
          git config user.email github-actions@github.com
          git tag -fa $MAJOR_VERSION -m "Update $MAJOR_VERSION tag"
          git push origin $MAJOR_VERSION --force